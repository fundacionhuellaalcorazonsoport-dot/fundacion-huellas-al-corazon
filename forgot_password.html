<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars icon-collapsed"></i> <i class="fas fa-times icon-expanded" style="display: none;"></i>
    </button>
    <header>
        <nav class="navbar"><div class="logo">Huellas al Corazón</div></nav>
    </header>

   <div id="mySidebar" class="sidebar">
        <a href="{{ url_for('index') }}"><i class="fas fa-home icon"></i> <span class="link-text">Inicio</span></a>
        <a href="{{ url_for('adopt') }}"><i class="fas fa-paw icon"></i> <span class="link-text">¡Adoptar Ahora!</span></a>
        
        {% if logged_in %}
        <a href="{{ url_for('my_adoptions') }}"><i class="fas fa-heart icon"></i> <span class="link-text">Mis Adopciones</span></a>
        <a href="{{ url_for('change_password') }}"><i class="fas fa-key icon"></i> <span class="link-text">Cambiar Clave</span></a>
        {% if current_user.username == 'gfiguera' %}
        <a href="{{ url_for('admin') }}"><i class="fas fa-user-shield icon"></i> <span class="link-text">Administración</span></a>
        <a href="{{ url_for('schedule_page') }}"><i class="fas fa-calendar-alt icon"></i> <span class="link-text">Calendario</span></a>    
        
        {% endif %}
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt icon"></i> <span class="link-text">Cerrar Sesión ({{ username }})</span></a>
        {% else %}
            <a href="{{ url_for('login_page') }}"><i class="fas fa-sign-in-alt icon"></i> <span class="link-text">Iniciar Sesión</span></a>
        {% endif %}
        <a href="{{ url_for('how_to_help') }}"><i class="fas fa-hand-holding-heart icon"></i> <span class="link-text">Cómo Ayudarnos</span></a>
         <a href="{{ url_for('faq') }}"><i class="fas fa-question-circle icon"></i> <span class="link-text">Preguntas Frecuentes</span></a>
        <a href="{{ url_for('contact_page') }}"><i class="fas fa-envelope icon"></i> <span class="link-text">Contacto</span></a>
    </div>


    <div id="main-content">
        <div class="form-card">
            <h2>Recuperar Contraseña</h2>
            <p style="margin-bottom: 20px;">Ingresa tu correo electrónico y te enviaremos una contraseña temporal.</p>
            
            <div class="form-group">
                <label for="email">Correo Electrónico:</label>
                <input type="email" id="email" required>
            </div>
            
            <button type="submit" class="button primary" onclick="recoverPassword()">Enviar Correo</button>
            <div id="message" style="display:none; margin-top:15px; font-weight:bold;"></div>
            
            <p class="login-link" style="margin-top: 20px;">
                <a href="{{ url_for('login_page') }}">Volver al Inicio de Sesión</a>
            </p>
        </div>
    </div> 
    
    <div class="dogs-at-bottom-container">
        <img src="{{ url_for('static', filename='pie de pagina.png') }}" alt="Perros" class="dogs-at-bottom-image">
    </div>

    <footer><p>&copy; 2023 Huellas al Corazón.</p></footer>

    <script>
async function recoverPassword() {
            const email = document.getElementById('email').value;
            const msgDiv = document.getElementById('message');
            
            if(!email) return alert("Por favor ingresa tu correo.");
            
            msgDiv.style.display = 'block';
            msgDiv.textContent = "Enviando...";
            msgDiv.style.color = "blue";

            try {
                const response = await fetch('/forgot_password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ email: email })
                });
                const data = await response.json();
                
            if (data.success) {
                    msgDiv.textContent = "¡Enviado! Redirigiendo al login...";
                    msgDiv.style.color = "green";
                    
                    // Esperamos 2 segundos y redirigimos con el parámetro ?next=
                    setTimeout(() => {
                        window.location.href = "/login?next=/change_password";
                    }, 2000);
                    
                } else {
                    msgDiv.textContent = data.message;
                    msgDiv.style.color = "red";
                }
                
            } catch (error) {
                msgDiv.textContent = "Error de conexión.";
                msgDiv.style.color = "red";
            }
        }
        function toggleSidebar() {
            const s = document.getElementById("mySidebar");
            const m = document.getElementById("main-content");
            s.classList.toggle('open'); m.classList.toggle('shifted');
        }
    </script>
</body>
</html>