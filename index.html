<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Huellas al Corazón - Inicio</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"> 
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Contenedor editable para las fotos del grid */
        .editable-container {
            position: relative;
            overflow: hidden;
        }
        /* Botón de pincel flotante */
        .edit-overlay-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--color-fucsia);
            border: 2px solid var(--color-fucsia);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
        }
        .edit-overlay-btn:hover {
            transform: scale(1.1);
            background: var(--color-fucsia);
            color: white;
        }
        /* Ajustes para el Hero Dinámico */
        .hero-section {
            position: relative;
            background-color: #333;
            /* Desactivamos la animación CSS fija para usar la dinámica de JS */
            animation: none !important; 
            transition: background-image 1s ease-in-out;
        }
        .admin-hero-controls {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 20;
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars icon-collapsed"></i> <i class="fas fa-times icon-expanded" style="display: none;"></i> 
    </button>

    <header>
        <nav class="navbar">
            <div class="logo">Fundación Huellas al Corazón</div>
        </nav>
    </header>

    <div id="mySidebar" class="sidebar">
        <a href="{{ url_for('index') }}"><i class="fas fa-home icon"></i> <span class="link-text">Inicio</span></a>
        <a href="{{ url_for('adopt') }}"><i class="fas fa-paw icon"></i> <span class="link-text">¡Adoptar Ahora!</span></a>
        
        {% if logged_in %}
            <a href="{{ url_for('my_adoptions') }}"><i class="fas fa-heart icon"></i> <span class="link-text">Mis Adopciones</span></a>
            {% if current_user.username == 'gfiguera' %}
                <a href="{{ url_for('admin') }}"><i class="fas fa-user-shield icon"></i> <span class="link-text">Administración</span></a>
                <a href="{{ url_for('schedule_page') }}"><i class="fas fa-calendar-alt icon"></i> <span class="link-text">Calendario</span></a>    
            {% endif %}
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt icon"></i> <span class="link-text">Cerrar Sesión ({{ username }})</span></a>
        {% else %}
            <a href="{{ url_for('login_page') }}"><i class="fas fa-sign-in-alt icon"></i> <span class="link-text">Iniciar Sesión</span></a>
        {% endif %}
        <a href="{{ url_for('how_to_help') }}"><i class="fas fa-hand-holding-heart icon"></i> <span class="link-text">Cómo Ayudarnos</span></a>
        <a href="{{ url_for('faq') }}"><i class="fas fa-question-circle icon"></i> <span class="link-text">Preguntas Frecuentes</span></a>
        <a href="{{ url_for('contact_page') }}"><i class="fas fa-envelope icon"></i> <span class="link-text">Contacto</span></a>
    </div>

    <div id="main-content">
        {# Contenedor de mensajes flash #}
        <div id="flash-message-container">
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">
                            {{ message }}
                        </div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
        </div>

        <div class="hero-section content-card" id="hero-section">
            {% if current_user.username == 'gfiguera' %}
            <div class="admin-hero-controls">
                <button class="button primary" onclick="openHeroManager()" style="padding: 5px 15px; font-size: 0.9rem;">
                    <i class="fas fa-images"></i> Gestionar Carrusel
                </button>
            </div>
            {% endif %}

            <h1>¡Huellas al Corazón!</h1>
            <p>Conecta con tu nuevo mejor amigo. Adoptar salva vidas.</p>
            <a href="{{ url_for('adopt') }}" class="button primary">Ver Perros en Adopción</a>
        </div>

        <div class="info-section content-card ">
            <h2>¿Por qué adoptar?</h2>
            <p>Adoptar un animal es un acto de amor incondicional y gratitud. Al adoptar, liberas espacio en el refugio para otro animal necesitado y contribuyes a reducir el número de animales sin hogar.</p>
        </div>

        <div class="content-card hidden quienes-somos-container">
            <div class="center-section-content">
                <div class="quienes-somos-text">
                    <h2>Quienes Somos</h2>
                    <p>Somos la Fundación Huellas al Corazon, un equipo apasionado y comprometido con el bienestar de los cachorros en situación de vulnerabilidad. Desde 2018, trabajamos para rescatar, rehabilitar y encontrar hogares amorosos a perritos abandonados, enfermos o en riesgo. Nuestra misión es brindar una segunda oportunidad a los más necesitados, promoviendo la adopción responsable y la educación sobre el cuidado animal. Cada año logramos rescatar y dar en adopción a más de 200 cachorros..</p>
                </div>
                
                <div class="photos-container">
                    <div class="photo-card hidden left-to-right editable-container">
                        {% if current_user.username == 'gfiguera' %}
                            <label class="edit-overlay-btn" title="Cambiar Foto">
                                <i class="fas fa-paint-brush"></i>
                                <input type="file" style="display:none" onchange="uploadPhoto(this, 'about_1')">
                            </label>
                        {% endif %}
                        <img src="{{ url_for('static', filename='uploads/' + about_photos['about_1'].photo_path) if about_photos['about_1'] else url_for('static', filename='qs1.jfif') }}" alt="Foto de perro 1">
                    </div>

                    <div class="photo-card hidden right-to-left editable-container">
                        {% if current_user.username == 'gfiguera' %}
                            <label class="edit-overlay-btn" title="Cambiar Foto">
                                <i class="fas fa-paint-brush"></i>
                                <input type="file" style="display:none" onchange="uploadPhoto(this, 'about_2')">
                            </label>
                        {% endif %}
                        <img src="{{ url_for('static', filename='uploads/' + about_photos['about_2'].photo_path) if about_photos['about_2'] else url_for('static', filename='qs2.jfif') }}" alt="Foto de perro 2">
                    </div>

                    <div class="photo-card hidden left-to-right editable-container">
                        {% if current_user.username == 'gfiguera' %}
                            <label class="edit-overlay-btn" title="Cambiar Foto">
                                <i class="fas fa-paint-brush"></i>
                                <input type="file" style="display:none" onchange="uploadPhoto(this, 'about_3')">
                            </label>
                        {% endif %}
                        <img src="{{ url_for('static', filename='uploads/' + about_photos['about_3'].photo_path) if about_photos['about_3'] else url_for('static', filename='qs3.jfif') }}" alt="Foto de perro 3">
                    </div>

                    <div class="photo-card hidden right-to-left editable-container">
                        {% if current_user.username == 'gfiguera' %}
                            <label class="edit-overlay-btn" title="Cambiar Foto">
                                <i class="fas fa-paint-brush"></i>
                                <input type="file" style="display:none" onchange="uploadPhoto(this, 'about_4')">
                            </label>
                        {% endif %}
                        <img src="{{ url_for('static', filename='uploads/' + about_photos['about_4'].photo_path) if about_photos['about_4'] else url_for('static', filename='qs4.jfif') }}" alt="Foto de perro 4">
                    </div>
                </div>
            </div>
        </div>

        <div class="content-card hidden">
            <h2>Nuestra Historia</h2>
            <p>Nacimos de un profundo amor por los animales y la convicción de que todo ser vivo merece un hogar seguro y lleno de cariño. Desde nuestra fundación en el año [Año de Fundación], hemos trabajado incansablemente para rescatar, rehabilitar y reubicar a cientos de perros en familias amorosas, construyendo un futuro mejor para ellos.</p>
        </div>

        <div class="content-card hidden">
            <h2>Nuestros Valores</h2>
            <p>Nos guiamos por valores fundamentales que rigen cada una de nuestras acciones: **Compasión** por el sufrimiento animal, **Respeto** a la vida, **Responsabilidad** en el cuidado y la educación, **Transparencia** en nuestra gestión,...</p>
        </div>

        <div class="content-card hidden">
            <h2>Nuestro Equipo</h2>
            <p>Nuestro equipo está conformado por apasionados voluntarios, veterinarios dedicados, etólogos y personal administrativo, todos unidos por el mismo propósito: mejorar la vida de los perros y promover la tenencia responsable en nuestra comunidad. Su entrega y amor incondicional hacen posible cada rescate y cada adopción exitosa.</p>
        </div>

        <div class="content-card hidden">
            <h2>Qué Hacemos: Programas y Servicios</h2>
            <p>En "Huellas al Corazón", ofrecemos una variedad de programas y servicios esenciales:</p>
            <ul>
                <li>**Rescate y Rehabilitación:** Salvamos perros en situaciones de riesgo y les brindamos atención integral.</li>
                <li>**Atención Veterinaria:** Aseguramos chequeos, vacunas, desparasitación y esterilización para todos nuestros rescatados.</li>
                <li>**Socialización y Entrenamiento:** Preparamos a los perros para una vida en familia, fomentando buenos comportamientos.</li>
                <li>**Programas de Adopción:** Conectamos a nuestros perros con familias amorosas y comprometidas.</li>
                <li>**Educación y Concienciación:** Realizamos campañas sobre la importancia de la esterilización, la tenencia responsable y el respeto animal.</li>
                <li>**Apoyo Post-Adopción:** Brindamos seguimiento y asesoría a las familias que han adoptado.</li>
            </ul>
        </div>

        <div class="content-card hidden">
            <h2>Cómo Rescatamos y Rehabilitamos a los Perros</h2>
            <p>Nuestro proceso comienza con la alerta de un perro en situación de abandono, maltrato o riesgo. Tras el rescate, el perro es llevado a nuestras instalaciones o a una casa de tránsito donde recibe:</p>
            <ol>
                <li>**Evaluación Inicial:** Un chequeo veterinario completo para determinar su estado de salud.</li>
                <li>**Atención Médica:** Tratamiento de enfermedades, desparasitación, vacunación y esterilización obligatoria.</li>
                <li>**Rehabilitación Conductual:** Sesiones con etólogos para superar traumas y aprender a convivir.</li>
                <li>**Socialización:** Interacción con otros perros y personas para fomentar su adaptación.</li>
                <li>**Preparación para la Adopción:** Una vez física y emocionalmente recuperado, el perro está listo para encontrar su hogar definitivo.</li>
            </ol>
            <p>Cada etapa es vital para asegurar que el perro tenga la mejor oportunidad de una vida plena y feliz.</p>
        </div>

    </div> 
    
    <div class="dogs-at-bottom-container">
        <img src="{{ url_for('static', filename='pie de pagina.png') }}" alt="Perros en el suelo" class="dogs-at-bottom-image">
    </div>

    <footer>
        <p>&copy; 2023 Huellas al Corazón. Todos los derechos reservados.</p>
    </footer>

    <div id="hero-manager-modal" class="modal" style="display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.6);">
        <div class="modal-content" style="background:white; margin:5% auto; padding:20px; width:80%; max-width:600px; border-radius:15px; position:relative;">
            <span onclick="document.getElementById('hero-manager-modal').style.display='none'" style="position:absolute; right:20px; top:10px; font-size:30px; cursor:pointer;">&times;</span>
            <h2 style="color:var(--color-azul-electrico); text-align: center;">Gestor de Portada</h2>
            
            <div style="background:#f0f2f5; padding:15px; border-radius:10px; margin-bottom:20px; text-align: center;">
                <h4>Agregar Nueva Foto al Carrusel:</h4>
                <input type="file" id="new-hero-photo">
                <button class="button primary" onclick="uploadHeroPhoto()" style="margin-top: 10px;">Subir Foto</button>
            </div>

            <h4 style="text-align: center;">Fotos Actuales:</h4>
            <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap:10px; margin-top: 10px;">
                {% for photo in hero_photos %}
                <div style="position:relative;">
                    <img src="{{ url_for('static', filename='uploads/' + photo.photo_path) }}" style="width:100%; height:80px; object-fit:cover; border-radius:5px;">
                    <button onclick="deleteSitePhoto({{ photo.id }})" style="position:absolute; top:-5px; right:-5px; background:red; color:white; border:none; border-radius: 50%; width: 25px; height: 25px; cursor:pointer;" title="Eliminar">&times;</button>
                </div>
                {% endfor %}
                {% if not hero_photos %}
                    <p style="grid-column: 1/-1; text-align: center; color: #666;">Se están usando las fotos por defecto.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <script>
        function toggleSidebar() {
            const sidebar = document.getElementById("mySidebar");
            const mainContent = document.getElementById("main-content");
            const navbar = document.querySelector(".navbar"); 
            const toggleIconCollapsed = document.querySelector(".sidebar-toggle .icon-collapsed");
            const toggleIconExpanded = document.querySelector(".sidebar-toggle .icon-expanded");

            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open');
                mainContent.classList.remove('shifted');
                navbar.classList.remove('shifted'); 
                toggleIconCollapsed.style.display = 'block'; 
                toggleIconExpanded.style.display = 'none'; 
            } else {
                sidebar.classList.add('open');
                mainContent.classList.add('shifted');
                navbar.classList.add('shifted'); 
                toggleIconCollapsed.style.display = 'none'; 
                toggleIconExpanded.style.display = 'block'; 
            }
        }

        window.onclick = function(event) {
            const sidebar = document.getElementById("mySidebar");
            const toggleButton = document.querySelector(".sidebar-toggle");
            if (sidebar.classList.contains('open') && !sidebar.contains(event.target) && !toggleButton.contains(event.target)) {
                toggleSidebar(); 
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(message => {
                setTimeout(() => {
                    message.style.opacity = '0';
                    message.style.transition = 'opacity 1s ease-out';
                    setTimeout(() => { message.remove(); }, 1000);
                }, 3000);
            });

            // Estado inicial Sidebar
            const sidebar = document.getElementById("mySidebar");
            const mainContent = document.getElementById("main-content");
            const navbar = document.querySelector(".navbar");
            const toggleIconCollapsed = document.querySelector(".sidebar-toggle .icon-collapsed");
            const toggleIconExpanded = document.querySelector(".sidebar-toggle .icon-expanded");

            sidebar.classList.remove('open'); 
            mainContent.classList.remove('shifted'); 
            navbar.classList.remove('shifted'); 
            toggleIconCollapsed.style.display = 'block';
            toggleIconExpanded.style.display = 'none';
        });

        // Intersection Observer
        const observer = new IntersectionObserver(entries => {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('visible');
                } else {
                    entry.target.classList.remove('visible');
                }
            });
        }, { threshold: 0 });

        const hiddenElements = document.querySelectorAll('.hidden');
        hiddenElements.forEach(element => observer.observe(element));

        // --- NUEVA LÓGICA DEL CARRUSEL DINÁMICO ---
        const heroImages = [
            {% for photo in hero_photos %}
                "{{ url_for('static', filename='uploads/' + photo.photo_path) }}",
            {% endfor %}
        ];
        
        // Si no hay fotos subidas, usar las fotos por defecto (asegúrate de que existan en static)
        if (heroImages.length === 0) {
            heroImages.push("{{ url_for('static', filename='perro1.jpeg') }}");
            heroImages.push("{{ url_for('static', filename='perro2.jpeg') }}");
            heroImages.push("{{ url_for('static', filename='perro3.jpeg') }}");
        }

        let heroIndex = 0;
        const heroSection = document.getElementById('hero-section');

        function changeHeroBackground() {
            if (heroImages.length > 0) {
                // Pre-cargar la siguiente imagen para evitar parpadeo
                const img = new Image();
                img.src = heroImages[heroIndex];
                img.onload = () => {
                    heroSection.style.backgroundImage = `linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('${heroImages[heroIndex]}')`;
                };
                heroIndex = (heroIndex + 1) % heroImages.length;
            }
        }

        // Iniciar rotación
        changeHeroBackground();
        setInterval(changeHeroBackground, 4000); // Cambia cada 4 segundos

        // --- FUNCIONES DE GESTIÓN (ADMIN) ---
        
        // 1. Subir Foto (Grid y Hero)
        async function uploadPhoto(input, section) {
            if (!input.files[0]) return;
            
            const formData = new FormData();
            formData.append('photo', input.files[0]);
            formData.append('section', section);

            try {
                const res = await fetch('/upload_site_photo', { method: 'POST', body: formData });
                const data = await res.json();
                if (data.success) location.reload();
                else alert('Error al subir: ' + data.message);
            } catch(e) { console.error(e); alert('Error de conexión'); }
        }

        // 2. Abrir Modal Hero
        function openHeroManager() {
            document.getElementById('hero-manager-modal').style.display = 'block';
        }

        // 3. Subir desde el Modal
        function uploadHeroPhoto() {
            const input = document.getElementById('new-hero-photo');
            if (input.files.length === 0) return alert("Selecciona una foto primero");
            uploadPhoto(input, 'hero');
        }

        // 4. Eliminar Foto del Carrusel
        async function deleteSitePhoto(id) {
            if(!confirm("¿Eliminar esta foto del carrusel?")) return;
            try {
                const res = await fetch(`/delete_site_photo/${id}`, { method: 'DELETE' });
                const data = await res.json();
                if (data.success) location.reload();
                else alert('Error al eliminar');
            } catch(e) { console.error(e); }
        }
    </script>

    <a href="{{ url_for('events_page') }}" class="floating-btn" title="Eventos y Noticias">
        <i class="fas fa-calendar-alt"></i>
    </a>
</body>
</html>