<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrarse</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">
    <i class="fas fa-bars icon-collapsed"></i> <i class="fas fa-times icon-expanded" style="display: none;"></i> </button>
    <header>
        <nav class="navbar"><div class="logo">Huellas al Corazón</div></nav>
    </header>

    <div id="mySidebar" class="sidebar">
        <a href="{{ url_for('index') }}"><i class="fas fa-home icon"></i> <span class="link-text">Inicio</span></a>
        <a href="{{ url_for('adopt') }}"><i class="fas fa-paw icon"></i> <span class="link-text">¡Adoptar Ahora!</span></a>
        {% if logged_in %}
            <a href="{{ url_for('my_adoptions') }}"><i class="fas fa-heart icon"></i> <span class="link-text">Mis Adopciones</span></a>
            {% if current_user.username == 'gfiguera' %}
                <a href="{{ url_for('admin') }}"><i class="fas fa-user-shield icon"></i> <span class="link-text">Administración</span></a>
                <a href="{{ url_for('schedule_page') }}"><i class="fas fa-calendar-alt icon"></i> <span class="link-text">Calendario</span></a>    
            {% endif %}
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt icon"></i> <span class="link-text">Cerrar Sesión ({{ username }})</span></a>
        {% else %}
            <a href="{{ url_for('login_page') }}"><i class="fas fa-sign-in-alt icon"></i> <span class="link-text">Iniciar Sesión</span></a>
        {% endif %}
        <a href="{{ url_for('how_to_help') }}"><i class="fas fa-hand-holding-heart icon"></i> <span class="link-text">Cómo Ayudarnos</span></a>
        <a href="{{ url_for('faq') }}"><i class="fas fa-question-circle icon"></i> <span class="link-text">Preguntas Frecuentes</span></a>
        <a href="{{ url_for('contact_page') }}"><i class="fas fa-envelope icon"></i> <span class="link-text">Contacto</span></a>
    </div>

    <div id="main-content">
        <div class="form-card">
            <h2>Crear una Cuenta</h2>
            
            <div class="form-group">
                <label for="cedula">Cédula de Identidad:</label>
                <input type="text" id="cedula" name="cedula" placeholder="Ej: V-12345678" required>
            </div>
            <div class="form-group">
                <label for="username">Usuario:</label>
                <input type="text" id="username" name="username" required>
            </div>
            <div class="form-group">
                <label for="email">Email:</label>
                <input type="email" id="email" name="email" required>
            </div>
            <div class="form-group">
                <label for="password">Contraseña:</label>
                <input type="password" id="password" name="password" required>
            </div>
            <div class="form-group">
                <label for="confirm-password">Confirmar Contraseña:</label>
                <input type="password" id="confirm-password" name="confirm-password" required>
            </div>
            <button type="submit" class="button primary" onclick="registerUser()">Registrarse</button>
            <div id="error-message" class="error-message" style="display: none;"></div>
            <p class="login-link">¿Ya tienes una cuenta? <a href="{{ url_for('login_page') }}">Inicia sesión aquí</a></p>
        </div>
    </div> 
    
    <div class="dogs-at-bottom-container">
        <img src="{{ url_for('static', filename='pie de pagina.png') }}" alt="Perros en el suelo" class="dogs-at-bottom-image">
    </div>

    <footer><p>&copy; 2023 Huellas al Corazón. Todos los derechos reservados.</p></footer>

    <script>
        async function registerUser() {
            // CAMBIO 2: LEER LA CÉDULA
            const cedula = document.getElementById('cedula').value;
            const username = document.getElementById('username').value;
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            const errorMessageDiv = document.getElementById('error-message');

            errorMessageDiv.style.display = 'none';

            if (!cedula) {
                errorMessageDiv.textContent = 'La Cédula es obligatoria.';
                errorMessageDiv.style.display = 'block';
                return;
            }

            if (password !== confirmPassword) {
                errorMessageDiv.textContent = 'Las contraseñas no coinciden.';
                errorMessageDiv.style.display = 'block';
                return;
            }

            try {
                const response = await fetch('/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    // CAMBIO 3: ENVIAR LA CÉDULA AL SERVIDOR
                    body: JSON.stringify({ username, email, password, cedula }),
                });

                const data = await response.json();

                if (response.ok) {
                    window.location.href = data.redirect || '/login';
                } else {
                    errorMessageDiv.textContent = data.message || 'Error en el registro.';
                    errorMessageDiv.style.display = 'block';
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessageDiv.textContent = 'Error de conexión. Inténtalo de nuevo.';
                errorMessageDiv.style.display = 'block';
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById("mySidebar");
            const mainContent = document.getElementById("main-content");
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open'); mainContent.classList.remove('shifted');
            } else {
                sidebar.classList.add('open'); mainContent.classList.add('shifted');
            }
        }
        function closeSidebar() {
            document.getElementById("mySidebar").classList.remove('open');
            document.getElementById("main-content").classList.remove('shifted');
        }
        window.onclick = function(event) {
            const sidebar = document.getElementById("mySidebar");
            const toggleButton = document.querySelector(".sidebar-toggle");
            if (sidebar && toggleButton && !sidebar.contains(event.target) && !toggleButton.contains(event.target) && sidebar.classList.contains('open')) {
                closeSidebar();
            }
        }
    </script>
</body>
</html>