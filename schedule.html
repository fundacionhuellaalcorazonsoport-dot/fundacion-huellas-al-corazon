<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario de Eventos - Huellas al Corazón</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* Estilos para los inputs de hora personalizados */
        .time-input-group {
            display: flex;
            gap: 5px;
            align-items: center;
        }
        .time-input-group input, .time-input-group select {
            padding: 10px;
            border: 1px solid var(--color-borde);
            border-radius: 5px;
            font-family: 'Patrick Hand', sans-serif;
            font-size: 1rem;
        }
        .time-input-group input { width: 60px; text-align: center; }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars icon-collapsed"></i> <i class="fas fa-times icon-expanded" style="display: none;"></i> </button>

    <header>
        <nav class="navbar"><div class="logo">Huellas al Corazón</div></nav>
    </header>

    <div id="mySidebar" class="sidebar">
        <a href="{{ url_for('index') }}"><i class="fas fa-home icon"></i> <span class="link-text">Inicio</span></a>
        <a href="{{ url_for('adopt') }}"><i class="fas fa-paw icon"></i> <span class="link-text">¡Adoptar Ahora!</span></a>
        {% if logged_in %}
        <a href="{{ url_for('my_adoptions') }}"><i class="fas fa-heart icon"></i> <span class="link-text">Mis Adopciones</span></a>
            {% if current_user.username == 'gfiguera' %}
        <a href="{{ url_for('admin') }}"><i class="fas fa-user-shield icon"></i> <span class="link-text">Administración</span></a>
        <a href="{{ url_for('schedule_page') }}"><i class="fas fa-calendar-alt icon"></i> <span class="link-text">Calendario</span></a>    
        {% endif %}
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt icon"></i> <span class="link-text">Cerrar Sesión ({{ username }})</span></a>
        {% else %}
            <a href="{{ url_for('login_page') }}"><i class="fas fa-sign-in-alt icon"></i> <span class="link-text">Iniciar Sesión</span></a>
        {% endif %}
        <a href="{{ url_for('how_to_help') }}"><i class="fas fa-hand-holding-heart icon"></i> <span class="link-text">Cómo Ayudarnos</span></a>
         <a href="{{ url_for('faq') }}"><i class="fas fa-question-circle icon"></i> <span class="link-text">Preguntas Frecuentes</span></a>
        <a href="{{ url_for('contact_page') }}"><i class="fas fa-envelope icon"></i> <span class="link-text">Contacto</span></a>
    </div>

    <div id="main-content" class="main-content">
        
    {% if is_admin %}
    <div class="content-card admin-form-card" id="admin-event-form">
        <h2><i class="fas fa-edit"></i> Gestión de Eventos</h2>
        <form id="event-upload-form">
            <input type="hidden" id="event-id" name="id">
            
            <div class="form-group">
                <label for="title"><i class="fas fa-bullhorn"></i> Título del Evento</label>
                <input type="text" id="title" name="title" required placeholder="Ej: Jornada de Adopción Especial">
            </div>

            <div class="form-grid">
                <div class="form-group">
                    <label for="date"><i class="fas fa-calendar-alt"></i> Fecha</label>
                    <input type="date" id="date" name="date" required>
                </div>
                <div class="form-group">
                    <label for="location"><i class="fas fa-map-marker-alt"></i> Ubicación</label>
                    <input type="text" id="location" name="location" placeholder="Ej: Parque Central">
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-clock"></i> Hora de Inicio</label>
                    <div class="time-input-group">
                        <input type="number" id="start_h" min="1" max="12" placeholder="12" required> :
                        <input type="number" id="start_m" min="0" max="59" placeholder="00" required>
                        <select id="start_ampm">
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                    <input type="hidden" id="time" name="time">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-flag-checkered"></i> Hora Final</label>
                    <div class="time-input-group">
                        <input type="number" id="end_h" min="1" max="12" placeholder="12" required> :
                        <input type="number" id="end_m" min="0" max="59" placeholder="00" required>
                        <select id="end_ampm">
                            <option value="AM">AM</option>
                            <option value="PM">PM</option>
                        </select>
                    </div>
                    <input type="hidden" id="end_time" name="end_time">
                </div>
            </div>

            <div class="form-group">
                <label for="description"><i class="fas fa-align-left"></i> Descripción</label>
                <textarea id="description" name="description" rows="3" required placeholder="Describe los detalles del evento..."></textarea>
            </div>
            
            <div class="form-group" id="photo-upload-group">
                <label for="photo"><i class="fas fa-image"></i> Foto del Evento</label>
                <input type="file" id="photo" name="photo" accept="image/*">

                 <div style="margin-top: 15px; text-align: center;">
                    <img id="event-photo-preview" src="#" alt="Vista Previa" 
                        style="display: none; max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid var(--color-fucsia); object-fit: contain; margin: 0 auto;">
            </div>
            </div>

            <div class="form-buttons">
                <button type="button" id="cancel-edit-btn" class="button secondary" style="display: none;"><i class="fas fa-times"></i> Cancelar</button>
                <button type="submit" id="submit-btn" class="button primary"><i class="fas fa-plus-circle"></i> Agregar Evento</button>
            </div>
        </form>
    </div>
    {% endif %}

        <div class="content-card calendar-card">
            <div class="calendar-header">
                <button id="prev-month" class="button icon-only"><i class="fas fa-chevron-left"></i></button>
                <h2 id="current-month-year">Mes Año</h2>
                <button id="next-month" class="button icon-only"><i class="fas fa-chevron-right"></i></button>
            </div>
            <div class="calendar-days-of-week">
                <div>Dom</div><div>Lun</div><div>Mar</div><div>Mié</div><div>Jue</div><div>Vie</div><div>Sáb</div>
            </div>
            <div class="calendar-grid" id="calendar-grid">
                </div>
        </div>

        <div id="event-modal" class="modal">
            <div class="modal-content" style="text-align: center;">
                <span class="close-btn" style="position: absolute; right: 20px; top: 10px; font-size: 2rem; cursor: pointer;">&times;</span>
                
                <div style="margin-bottom: 15px;">
                    <img id="modal-photo" src="" alt="Foto del Evento" 
                         style="width: 100%; max-height: 300px; object-fit: cover; border-radius: 10px; border: 2px solid var(--color-azul-electrico); display: none;">
                </div>

                <h3 id="modal-title" style="color: var(--color-fucsia); font-size: 1.8rem; margin-bottom: 10px;"></h3>
                
                <p id="modal-date-time" style="font-size: 1.1rem; color: #555; margin-bottom: 5px;"></p>
                <p id="modal-location" style="font-size: 1.1rem; color: var(--color-azul-electrico); font-weight: bold; margin-bottom: 15px;"></p>
                
                <p id="modal-description" style="background: #f9f9f9; padding: 15px; border-radius: 10px; text-align: left;"></p>
                
                {% if is_admin %}
                <div class="modal-admin-actions" style="margin-top: 20px; display: flex; justify-content: center; gap: 15px;">
                    <button id="modal-edit-btn" class="button secondary"><i class="fas fa-edit"></i> Editar</button>
                    <button id="modal-delete-btn" class="button delete" style="background-color: var(--color-error); color: white;"><i class="fas fa-trash-alt"></i> Eliminar</button>
                </div>
                {% endif %}
            </div>
        </div>

        <footer>
            <p>&copy; 2023 Huellas al Corazón. Todos los derechos reservados.</p>
        </footer>
    </div>
    
    <script>
        const calendarGrid = document.getElementById('calendar-grid');
        const monthYearDisplay = document.getElementById('current-month-year');
        const eventModal = document.getElementById('event-modal');
        const closeModalBtn = document.querySelector('.close-btn');
        const adminForm = document.getElementById('event-upload-form');
        const isAdmin = {{ 'true' if is_admin else 'false' }};
        
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let allEvents = [];
        
       async function fetchEvents() {
            try {
                const response = await fetch('/api/events'); 
                if (!response.ok) throw new Error('Error al obtener eventos');
                allEvents = await response.json();
                renderCalendar();
            } catch (error) {
                console.error("Fallo al cargar eventos:", error);
                renderCalendar(); 
            }
        }

        function renderCalendar() {
            calendarGrid.innerHTML = ''; 
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            const startDayOfWeek = firstDayOfMonth.getDay(); 

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            monthYearDisplay.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            
            for (let i = 0; i < startDayOfWeek; i++) {
                calendarGrid.innerHTML += '<div class="calendar-day empty"></div>';
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dateISO = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const eventsOnThisDay = allEvents.filter(event => event.date === dateISO);
                
                let classes = 'calendar-day';
                if (eventsOnThisDay.length > 0) classes += ' has-event';
                const today = new Date();
                if (day === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) classes += ' today';

                const eventMarkers = eventsOnThisDay.map(e => `<span class="event-marker" title="${e.title}"></span>`).join('');
                
                const dayElement = document.createElement('div');
                dayElement.className = classes;
                dayElement.innerHTML = `<span>${day}</span>${eventMarkers}`;

                dayElement.addEventListener('click', () => {
                    if (eventsOnThisDay.length > 0) {
                        showEventModal(eventsOnThisDay[0]); 
                    }
                });
                calendarGrid.appendChild(dayElement);
            }
        }
        
        document.getElementById('prev-month').addEventListener('click', () => {
            currentMonth--;
            if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            renderCalendar();
        });

        document.getElementById('next-month').addEventListener('click', () => {
            currentMonth++;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; }
            renderCalendar();
        });

    // --- FUNCIÓN PARA CONVERTIR HORA 12H A 24H (Para enviar a Backend) ---
    function convertTo24Hour(h, m, ampm) {
        let hour = parseInt(h);
        if (ampm === 'PM' && hour !== 12) hour += 12;
        if (ampm === 'AM' && hour === 12) hour = 0;
        return `${String(hour).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
    }

    // --- FUNCIÓN PARA MOSTRAR MODAL (FICHA) ---
    function showEventModal(event) {
        document.getElementById('modal-title').textContent = event.title;
        const dateObj = new Date(event.date);
        const formattedDate = dateObj.toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric' });
        
        document.getElementById('modal-date-time').innerHTML = `
            <i class="fas fa-calendar-alt"></i> ${formattedDate} <br> 
            <i class="fas fa-clock"></i> ${event.time} - ${event.end_time}`;
        
        document.getElementById('modal-location').innerHTML = `<i class="fas fa-map-marker-alt"></i> ${event.location || 'Sin ubicación'}`;
        document.getElementById('modal-description').textContent = event.description;
        
        // MOSTRAR FOTO EN MODAL
        const photoElement = document.getElementById('modal-photo');
        if (event.photo_path) {
            photoElement.src = `/static/uploads/${event.photo_path}`; // CORREGIDO RUTA
            photoElement.style.display = 'block';
        } else {
            photoElement.style.display = 'none';
        }

        if (isAdmin) {
            // Asignar funciones a los botones del modal
            const editBtn = document.getElementById('modal-edit-btn');
            const deleteBtn = document.getElementById('modal-delete-btn');
            
            // Clonamos los botones para eliminar eventos anteriores y evitar duplicados
            const newEditBtn = editBtn.cloneNode(true);
            const newDeleteBtn = deleteBtn.cloneNode(true);
            
            editBtn.parentNode.replaceChild(newEditBtn, editBtn);
            deleteBtn.parentNode.replaceChild(newDeleteBtn, deleteBtn);

            newEditBtn.onclick = () => {
                editEvent(event);
                eventModal.style.display = 'none';
            };
            newDeleteBtn.onclick = () => deleteEvent(event.id);
        }

        eventModal.style.display = 'block';
    }

        closeModalBtn.addEventListener('click', () => { eventModal.style.display = 'none'; });
        window.addEventListener('click', (event) => { if (event.target == eventModal) { eventModal.style.display = 'none'; } });
        
        // --- CRUD ADMINISTRACIÓN ---

        if (isAdmin) {
            adminForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                // 1. COMBINAR HORAS
                const startH = document.getElementById('start_h').value;
                const startM = document.getElementById('start_m').value;
                const startAmpm = document.getElementById('start_ampm').value;
                document.getElementById('time').value = convertTo24Hour(startH, startM, startAmpm);

                const endH = document.getElementById('end_h').value;
                const endM = document.getElementById('end_m').value;
                const endAmpm = document.getElementById('end_ampm').value;
                document.getElementById('end_time').value = convertTo24Hour(endH, endM, endAmpm);

                const isEditing = document.getElementById('event-id').value !== '';
                const formData = new FormData(adminForm);
                
                let url = '/api/events';
                let method = 'POST';
                let body = formData;
                let headers = {};

                if (isEditing) {
                    const eventId = formData.get('id');
                    url = `/api/events/${eventId}`;
                    method = 'PUT';
                    
                    body = JSON.stringify({
                        title: formData.get('title'),
                        date: formData.get('date'),
                        time: formData.get('time'), // Ya convertida a 24h
                        end_time: formData.get('end_time'), // Ya convertida a 24h
                        location: formData.get('location'),
                        description: formData.get('description'),
                    });
                    headers['Content-Type'] = 'application/json';
                }
                
                try {
                    const response = await fetch(url, { method: method, headers: headers, body: body });
                    const data = await response.json();

                    if (response.ok) {
                        alert(data.message);
                        resetForm();
                        fetchEvents();
                    } else {
                        alert('Error: ' + (data.message || 'Error desconocido'));
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('Error de conexión.');
                }
            });
        }

        // --- FUNCIÓN PARA CARGAR DATOS EN EL FORMULARIO (EDITAR) ---
        function editEvent(event) {
            document.getElementById('event-id').value = event.id;
            document.getElementById('title').value = event.title;
            document.getElementById('date').value = event.date;
            document.getElementById('location').value = event.location || ''; 
            document.getElementById('description').value = event.description;
            
            // Desglosar la hora (Viene como "02:30 PM" desde backend)
            // Función auxiliar para parsear "HH:MM AM/PM"
            const parseTimeStr = (timeStr) => {
                const [time, modifier] = timeStr.split(' ');
                let [hours, minutes] = time.split(':');
                return { h: hours, m: minutes, ampm: modifier };
            };

            const startTimeObj = parseTimeStr(event.time);
            document.getElementById('start_h').value = parseInt(startTimeObj.h);
            document.getElementById('start_m').value = startTimeObj.m;
            document.getElementById('start_ampm').value = startTimeObj.ampm;

            const endTimeObj = parseTimeStr(event.end_time);
            document.getElementById('end_h').value = parseInt(endTimeObj.h);
            document.getElementById('end_m').value = endTimeObj.m;
            document.getElementById('end_ampm').value = endTimeObj.ampm;
            
            // UI
            document.getElementById('photo-upload-group').style.display = 'none'; // Ocultar foto al editar
            document.getElementById('submit-btn').innerHTML = '<i class="fas fa-save"></i> Guardar Cambios';
            document.getElementById('cancel-edit-btn').style.display = 'inline-block';
            
            document.getElementById('admin-event-form').scrollIntoView({ behavior: 'smooth' });
        }
        
        function resetForm() {
            adminForm.reset();
            document.getElementById('event-id').value = '';
            document.getElementById('photo-upload-group').style.display = 'block';
            document.getElementById('submit-btn').innerHTML = '<i class="fas fa-plus-circle"></i> Agregar Evento';
            document.getElementById('cancel-edit-btn').style.display = 'none';
            // Reset preview
            const preview = document.getElementById('event-photo-preview');
            if(preview) { preview.style.display = 'none'; preview.src = '#'; }
        }

        if(document.getElementById('cancel-edit-btn')) {
            document.getElementById('cancel-edit-btn').addEventListener('click', resetForm);
        }

        async function deleteEvent(eventId) {
            if (!confirm('¿Estás seguro de que quieres eliminar este evento?')) return;
            try {
                const response = await fetch(`/api/events/${eventId}`, { method: 'DELETE' });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message);
                    eventModal.style.display = 'none'; 
                    fetchEvents(); 
                } else {
                    alert('Error: ' + data.message);
                }
            } catch (error) {
                alert('Error de conexión.');
            }
        }
        
        document.addEventListener('DOMContentLoaded', fetchEvents);

        function toggleSidebar() {
            const sidebar = document.getElementById("mySidebar");
            const mainContent = document.getElementById("main-content");
            if (sidebar.classList.contains('open')) {
                sidebar.classList.remove('open'); mainContent.classList.remove('shifted');
            } else {
                sidebar.classList.add('open'); mainContent.classList.add('shifted');
            }
        }

        // Vista previa de imagen
        const eventInput = document.getElementById('photo');
        const eventPreview = document.getElementById('event-photo-preview');
        if(eventInput) {
            eventInput.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        eventPreview.src = e.target.result;
                        eventPreview.style.display = 'block';
                    }
                    reader.readAsDataURL(file);
                } else {
                    eventPreview.src = '#';
                    eventPreview.style.display = 'none';
                }
            });
        }
    </script>
</body>
</html>