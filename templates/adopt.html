<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Adopta - Huellas al Corazón</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <!-- ESTILOS ADICIONALES (Anexados) -->
    <style>
        .form-section-title {
            width: 100%;
            border-bottom: 2px solid var(--color-azul-electrico);
            color: var(--color-azul-electrico);
            margin: 20px 0 15px 0;
            padding-bottom: 5px;
        }
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        .full-width { grid-column: 1 / -1; }
        
        /* Estilos Modal Nativo */
        .full-details-modal {
            border: none;
            border-radius: 15px;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .full-details-modal::backdrop {
            background: rgba(0,0,0,0.6);
        }
        .modal-body-grid {
            display: grid;
            grid-template-columns: 1fr 1.5fr;
            gap: 20px;
            margin-top: 20px;
        }
        .details-text h4 {
            color: var(--color-fucsia);
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-top: 15px;
        }
        .details-text ul {
            list-style: none;
            padding-left: 10px;
        }
        .details-text li {
            margin-bottom: 5px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .button.delete {
             background-color: var(--color-error);
             color: white;
        }
        /* (Fin Estilos Adicionales) */

        /* --- NUEVO: Estilos para la parte trasera de la tarjeta --- */
        .dog-details-back {
            padding: 20px;
            text-align: left;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: 100%;
            box-sizing: border-box;
        }
        .dog-details-back h3 {
            color: var(--color-fucsia);
            text-align: center;
            border-bottom: 2px solid var(--color-azul-electrico);
            padding-bottom: 10px;
        }
        .dog-details-back p {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        .dog-details-back p i {
            color: var(--color-azul-electrico);
            width: 20px;
            text-align: center;
        }
    </style>
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()">
        <i class="fas fa-bars icon-collapsed"></i> <i class="fas fa-times icon-expanded" style="display: none;"></i>
    </button>

    <header>
        <nav class="navbar"><div class="logo">Huellas al Corazón</div></nav>
    </header>

    <!-- SIDEBAR UNIFICADO (Mantenido) -->
   <div id="mySidebar" class="sidebar">
        <a href="{{ url_for('index') }}"><i class="fas fa-home icon"></i> <span class="link-text">Inicio</span></a>
        <a href="{{ url_for('adopt') }}"><i class="fas fa-paw icon"></i> <span class="link-text">¡Adoptar Ahora!</span></a>
        
        {% if logged_in %}
        <a href="{{ url_for('my_adoptions') }}"><i class="fas fa-heart icon"></i> <span class="link-text">Mis Adopciones</span></a>
            {% if current_user.username == 'gfiguera' %}
        <a href="{{ url_for('admin') }}"><i class="fas fa-user-shield icon"></i> <span class="link-text">Administración</span></a>
        <a href="{{ url_for('schedule_page') }}"><i class="fas fa-calendar-alt icon"></i> <span class="link-text">Calendario</span></a>    
        
        {% endif %}
            <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt icon"></i> <span class="link-text">Cerrar Sesión ({{ username }})</span></a>
        {% else %}
            <a href="{{ url_for('login_page') }}"><i class="fas fa-sign-in-alt icon"></i> <span class="link-text">Iniciar Sesión</span></a>
        {% endif %}
        <a href="{{ url_for('how_to_help') }}"><i class="fas fa-hand-holding-heart icon"></i> <span class="link-text">Cómo Ayudarnos</span></a>
         <a href="{{ url_for('faq') }}"><i class="fas fa-question-circle icon"></i> <span class="link-text">Preguntas Frecuentes</span></a>
        <a href="{{ url_for('contact_page') }}"><i class="fas fa-envelope icon"></i> <span class="link-text">Contacto</span></a>
    </div>


    <div id="main-content">
        
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                <div class="flash-messages-container">
                    {% for category, message in messages %}
                        <div class="flash-message flash-message-{{ category }}">{{ message }}</div>
                    {% endfor %}
                </div>
            {% endif %}
        {% endwith %}

        <div class="content-card">
            <h1>¡Conoce a nuestros rescatados!</h1>
            <p>Cada uno tiene una historia única y espera un hogar lleno de amor.</p>
        </div>

        <!-- FORMULARIO DE SUBIDA (Mantenido) -->
        {% if is_admin %}
        <div class="content-card admin-form-card">
            <h2 style="color: var(--color-fucsia);"><i class="fas fa-folder-plus"></i> Ficha Técnica de Ingreso</h2>
            <form action="{{ url_for('upload_dog') }}" method="POST" enctype="multipart/form-data" class="dog-upload-form">
                
                <!-- Datos Básicos (Mantenido) -->
                <h3 class="form-section-title">Datos Básicos</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Nombre:</label><input type="text" name="name" required></div>
                    <div class="form-group"><label>Sexo:</label><select name="sex" required><option value="Macho">Macho</option><option value="Hembra">Hembra</option></select></div>
                    <div class="form-group"><label>Edad Aprox:</label><input type="text" name="age" placeholder="Ej: 2 años"></div>
                    <div class="form-group"><label>Tamaño:</label><select name="size"><option value="Pequeño">Pequeño</option><option value="Mediano">Mediano</option><option value="Grande">Grande</option></select></div>
                    <div class="form-group"><label>Raza / Tipo:</label><input type="text" name="breed" placeholder="Ej: Mestizo"></div>
                    <div class="form-group"><label>Color:</label><input type="text" name="color"></div>
                    <div class="form-group"><label>Peso (kg):</label><input type="text" name="weight"></div>
                </div>

                <!-- Origen (Mantenido) -->
                <h3 class="form-section-title">Origen y Rescate</h3>
                <div class="form-grid">
                    <div class="form-group"><label>Rescatista:</label><input type="text" name="rescuer"></div>
                    <div class="form-group"><label>Lugar de Hallazgo:</label><input type="text" name="origin"></div>
                    <div class="form-group"><label>Fecha Llegada:</label><input type="date" name="arrival_date"></div>
                    <div class="form-group"><label>Nº Camada:</label><input type="text" name="litter_number" placeholder="Ej: 2024-A-03"></div>
                    <div class="form-group full-width"><label>Condición de Llegada:</label><textarea name="arrival_condition" rows="2"></textarea></div>
                </div>

                <!-- Salud (Mantenido) -->
                <h3 class="form-section-title">Historial Médico</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label>Estado de Salud:</label>
                        <select name="health_status">
                            <option value="Sano">Sano</option><option value="Enfermo">Enfermo</option><option value="En Tratamiento">En Tratamiento</option>
                        </select>
                    </div>
                    <div class="form-group"><label>Vacunación:</label><input type="text" name="vaccination_status" placeholder="Ej: Sextuple (1/3)"></div>
                    <div class="form-group"><label>Desparasitación:</label><input type="text" name="deworming_status" placeholder="Producto y fecha"></div>
                    <div class="form-group full-width"><label>Exámenes:</label><textarea name="exams" rows="2"></textarea></div>
                    <div class="form-group full-width"><label>Enfermedades:</label><textarea name="diseases" rows="2"></textarea></div>
                    <div class="form-group full-width"><label>Tratamientos:</label><textarea name="treatments" rows="3"></textarea></div>
                </div>

        <div class="form-group">
            <label>Foto Principal:</label>
            <input type="file" name="photo" id="dog-photo-input" accept="image/*" required>
                
                <div style="margin-top: 15px; text-align: center;">
                    <img id="dog-photo-preview" src="#" alt="Vista Previa" 
                        style="display: none; max-width: 100%; max-height: 300px; border-radius: 10px; border: 2px solid var(--color-azul-electrico); object-fit: contain; margin: 0 auto;">
                </div>
                </div>


                <button type="submit" class="button primary" style="width: 100%;">Guardar Ficha</button>
            </form>
        </div>
        {% endif %}

        <!-- LISTA DE PERROS -->
        <div class="dog-posts-container">
            {% for dog in dogs %}
                <div class="dog-post-card" onclick="this.classList.toggle('flipped')">
                    <!-- FRENTE DE LA TARJETA (Mantenido) -->
                    <div class="dog-post-card-front">
                        <img src="{{ url_for('static', filename='uploads/' + dog.photo_path) }}" alt="{{ dog.name }}" class="dog-photo">
                        <div class="front-details">
                            <h3>{{ dog.name }}</h3>
                            <p>{{ dog.sex }} | {{ dog.age }}</p>
                            <small>Toca para detalles</small>
                        </div>
                    </div>
                    
                    <!-- REVERSO DE LA TARJETA (MODIFICADO Y ESTILIZADO) -->
                    <div class="dog-post-card-back">
                        <div class="dog-details-back">
                            <h3>{{ dog.name }}</h3>
                            <p><i class="fas fa-venus-mars"></i> <strong>Sexo:</strong> {{ dog.sex }}</p>
                            <p><i class="fas fa-ruler-combined"></i> <strong>Tamaño:</strong> {{ dog.size or 'N/A' }}</p>
                            <p><i class="fas fa-heartbeat"></i> <strong>Salud:</strong> {{ dog.health_status or 'N/A' }}</p>
                            <p><i class="fas fa-syringe"></i> <strong>Vacunas:</strong> {{ dog.vaccination_status or 'N/A' }}</p>
                        </div>
                        <button class="button secondary" style="width: 100%;" onclick="event.stopPropagation(); openFullDetails({{ dog.id }})">
                            <i class="fas fa-info-circle"></i> Ver Ficha Completa
                        </button>
                    </div>
                </div>

                <!-- MODAL DE DETALLES COMPLETOS (MODIFICADO CON TODOS LOS DATOS) -->
                <dialog id="details-modal-{{ dog.id }}" class="full-details-modal">
                    <div class="modal-header">
                        <h2>Ficha de {{ dog.name }}</h2>
                        <button onclick="document.getElementById('details-modal-{{ dog.id }}').close()" class="close-btn">&times;</button>
                    </div>
                    
                    <div class="modal-body-grid">
                        <!-- Columna de Foto -->
                        <div>
                            <img src="{{ url_for('static', filename='uploads/' + dog.photo_path) }}" style="width: 100%; border-radius: 10px;">
                        </div>
                        
                        <!-- Columna de Información -->
                        <div class="details-text">
                            <h4><i class="fas fa-paw"></i> Información General</h4>
                            <ul>
                                <li><strong>Sexo:</strong> {{ dog.sex }}</li>
                                <li><strong>Edad:</strong> {{ dog.age }}</li>
                                <li><strong>Peso:</strong> {{ dog.weight or 'N/A' }}</li>
                                <li><strong>Color:</strong> {{ dog.color or 'N/A' }}</li>
                                <li><strong>Raza:</strong> {{ dog.breed or 'N/A' }}</li>
                            </ul>

                            <h4><i class="fas fa-home"></i> Origen y Rescate</h4>
                            <ul>
                                <li><strong>Rescatista:</strong> {{ dog.rescuer or 'N/A' }}</li>
                                <li><strong>Lugar de Hallazgo:</strong> {{ dog.origin or 'N/A' }}</li>
                                <li><strong>Fecha de Llegada:</strong> {{ dog.arrival_date.strftime('%d-%m-%Y') if dog.arrival_date else 'N/A' }}</li>
                                <li><strong>Nº Camada:</strong> {{ dog.litter_number or 'N/A' }}</li>
                            </ul>
                            
                            <h4><i class="fas fa-heartbeat"></i> Historial Médico</h4>
                            <p><strong>Condición de Llegada:</strong> {{ dog.arrival_condition or 'N/A' }}</p>
                            <p><strong>Estado de Salud:</strong> {{ dog.health_status or 'N/A' }}</p>
                            <p><strong>Vacunas:</strong> {{ dog.vaccination_status or 'N/A' }}</p>
                            <p><strong>Desparasitación:</strong> {{ dog.deworming_status or 'N/A' }}</p>
                            <p><strong>Exámenes:</strong> {{ dog.exams or 'N/A' }}</p>
                            <p><strong>Enfermedades:</strong> {{ dog.diseases or 'N/A' }}</p>
                            <p><strong>Tratamientos:</strong> {{ dog.treatments or 'N/A' }}</p>

                            <!-- BOTONES DE ACCIÓN (Lógica unificada) -->
                           <div class="modal-actions">
                            {% if is_admin %}
                                <button class="button secondary" onclick="event.stopPropagation(); openEditModal({{ dog.to_dict() | tojson | safe | forceescape }})">
                                    <i class="fas fa-edit"></i> Editar Ficha
                                </button>
                                
                                <button class="button delete" onclick="event.stopPropagation(); deleteDog({{ dog.id }})">
                                    <i class="fas fa-trash"></i> Eliminar Perro
                                </button>
                            {% else %}
                                <a href="{{ url_for('adopt_request_form', dog_id=dog.id) }}" class="button primary" style="display: block; text-align: center; width: 100%;">
                                    ¡Quiero Adoptar!
                                </a>
                            {% endif %}
                        </div>
                        </div>
                    </div>
                </dialog>
            {% endfor %}
        </div>
    </div>

    <!-- ========================================== -->
    <!--     MODAL PARA EDITAR PERRO (ANEXADO)      -->
    <!-- ========================================== -->
    <dialog id="edit-dog-modal" class="full-details-modal" style="max-width: 700px;">
        <div class="modal-header">
            <h2 style="color: var(--color-fucsia);">Editar Ficha</h2>
            <button onclick="closeEditModal()" class="close-btn">&times;</button>
        </div>
        
        <form id="edit-dog-form">
            <input type="hidden" id="edit-dog-id" name="id">
            
            <h3 class="form-section-title">Datos Básicos</h3>
            <div class="form-grid">
                <div class="form-group"><label>Nombre:</label><input type="text" id="edit-name" name="name" required></div>
                <div class="form-group"><label>Sexo:</label><select id="edit-sex" name="sex" required><option value="Macho">Macho</option><option value="Hembra">Hembra</option></select></div>
                <div class="form-group"><label>Edad Aprox:</label><input type="text" id="edit-age" name="age"></div>
                <div class="form-group"><label>Peso (kg):</label><input type="text" id="edit-weight" name="weight"></div>
                <div class="form-group"><label>Raza:</label><input type="text" id="edit-breed" name="breed"></div>
                <div class="form-group"><label>Color:</label><input type="text" id="edit-color" name="color"></div>
                <div class="form-group"><label>Tamaño:</label><select id="edit-size" name="size"><option value="Pequeño">Pequeño</option><option value="Mediano">Mediano</option><option value="Grande">Grande</option></select></div>
            </div>

            <h3 class="form-section-title">Origen y Rescate</h3>
            <div class="form-grid">
                <div class="form-group"><label>Rescatista:</label><input type="text" id="edit-rescuer" name="rescuer"></div>
                <div class="form-group"><label>Lugar de Hallazgo:</label><input type="text" id="edit-origin" name="origin"></div>
                <div class="form-group"><label>Fecha Llegada:</label><input type="date" id="edit-arrival_date" name="arrival_date"></div>
                <div class="form-group"><label>Nº Camada:</label><input type="text" id="edit-litter_number" name="litter_number"></div>
                <div class="form-group full-width"><label>Condición de Llegada:</label><textarea id="edit-arrival_condition" name="arrival_condition" rows="2"></textarea></div>
            </div>

            <h3 class="form-section-title">Historial Médico</h3>
            <div class="form-grid">
                 <div class="form-group">
                    <label>Estado de Salud:</label>
                    <select id="edit-health_status" name="health_status">
                        <option value="Sano">Sano</option><option value="Enfermo">Enfermo</option><option value="En Tratamiento">En Tratamiento</option>
                    </select>
                </div>
                <div class="form-group"><label>Vacunación:</label><input type="text" id="edit-vaccination_status" name="vaccination_status"></div>
                <div class="form-group"><label>Desparasitación:</label><input type="text" id="edit-deworming_status" name="deworming_status"></div>
                <div class="form-group full-width"><label>Exámenes:</label><textarea id="edit-exams" name="exams" rows="2"></textarea></div>
                <div class="form-group full-width"><label>Enfermedades:</label><textarea id="edit-diseases" name="diseases" rows="2"></textarea></div>
                <div class="form-group full-width"><label>Tratamientos:</label><textarea id="edit-treatments" name="treatments" rows="3"></textarea></div>
            </div>

            <button type="submit" class="button primary" style="width: 100%; margin-top: 20px;">Guardar Cambios</button>
        </form>
    </dialog>

        </div> <div class="dogs-at-bottom-container">
        <img src="{{ url_for('static', filename='pie de pagina.png') }}" alt="Perros en el suelo" class="dogs-at-bottom-image">
    </div>

    <footer>
        <p>&copy; 2023 Huellas al Corazón. Todos los derechos reservados.</p>
    </footer>
    <!-- ========================================== -->
    <!--          FIN DEL MODAL DE EDICIÓN          -->
    <!-- ========================================== -->


    <script>
        // Funciones Sidebar (Mantenido)
        function toggleSidebar() {
            document.getElementById("mySidebar").classList.toggle('open');
            document.getElementById("main-content").classList.toggle('shifted');
        }

        // Abrir Modal de Detalles (Mantenido)
        function openFullDetails(id) {
            document.getElementById('details-modal-' + id).showModal();
        }

        // Asignar Adopción (Mantenido)
        function assignAdoption(dogId) {
            event.stopPropagation();
            const username = document.getElementById('user-assign-' + dogId).value;
            if(!username) return alert("Ingresa el nombre de usuario del adoptante");

            if(confirm("¿Confirmar que " + username + " adoptó a este perro?")) {
                fetch('/assign_adoption', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ dog_id: dogId, username_adopter: username })
                })
                .then(r => r.json())
                .then(data => {
                    alert(data.message);
                    if(data.success) window.location.reload();
                });
            }
        }
        
        // --- JAVASCRIPT ANEXADO PARA EDITAR Y ELIMINAR ---
        
        const editModal = document.getElementById('edit-dog-modal');
        const editForm = document.getElementById('edit-dog-form');

        function openEditModal(dog) {
            // Rellena el formulario con los datos del perro
            document.getElementById('edit-dog-id').value = dog.id;
            document.getElementById('edit-name').value = dog.name;
            document.getElementById('edit-sex').value = dog.sex;
            document.getElementById('edit-age').value = dog.age;
            document.getElementById('edit-weight').value = dog.weight || '';
            document.getElementById('edit-size').value = dog.size || 'Mediano';
            document.getElementById('edit-breed').value = dog.breed || '';
            document.getElementById('edit-color').value = dog.color || '';
            document.getElementById('edit-rescuer').value = dog.rescuer || '';
            document.getElementById('edit-origin').value = dog.origin || '';
            
            // Formatear fecha: el .to_dict() de Python ya la envía como YYYY-MM-DD
            document.getElementById('edit-arrival_date').value = dog.arrival_date || '';
            
            document.getElementById('edit-litter_number').value = dog.litter_number || '';
            document.getElementById('edit-arrival_condition').value = dog.arrival_condition || '';
            document.getElementById('edit-health_status').value = dog.health_status || 'Sano';
            document.getElementById('edit-vaccination_status').value = dog.vaccination_status || '';
            document.getElementById('edit-deworming_status').value = dog.deworming_status || '';
            document.getElementById('edit-exams').value = dog.exams || '';
            document.getElementById('edit-diseases').value = dog.diseases || '';
            document.getElementById('edit-treatments').value = dog.treatments || '';
            
            editModal.showModal();
        }

        function closeEditModal() {
            editModal.close();
        }

        editForm.addEventListener('submit', function(event) {
            event.preventDefault();
            const dogId = document.getElementById('edit-dog-id').value;
            const formData = new FormData(editForm);
            const data = Object.fromEntries(formData.entries());

            fetch(`/edit_dog/${dogId}`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            })
            .then(r => r.json())
            .then(d => {
                alert(d.message);
                if(d.success) {
                    closeEditModal();
                    window.location.reload();
                }
            });
        });

        editModal.addEventListener('click', function(event) {
            if (event.target === editModal) {
                closeEditModal();
            }
        });
        
        function deleteDog(dogId) {
            event.stopPropagation();
            if (confirm('¿Estás seguro de que quieres eliminar este cachorro? ESTA ACCIÓN ES PERMANENTE.')) {
                fetch(`/delete_dog/${dogId}`, { 
                    method: 'POST' 
                })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || "Procesando..."); 
                    if (data.success) {
                        window.location.reload(); 
                    }
                })
                .catch(error => console.error('Error:', error));
            }
        }


// --- VISTA PREVIA DE IMAGEN (ADOPT.HTML) ---
    const dogInput = document.getElementById('dog-photo-input');
    const dogPreview = document.getElementById('dog-photo-preview');

    if(dogInput) {
        dogInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    dogPreview.src = e.target.result;
                    dogPreview.style.display = 'block';
                }
                reader.readAsDataURL(file);
            } else {
                dogPreview.src = '#';
                dogPreview.style.display = 'none';
            }
        });
    }

    </script>

</body>
</html>