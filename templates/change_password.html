<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cambiar Contraseña</title>
    <link rel="icon" href="{{ url_for('static', filename='logo.png') }}" type="image/png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <button class="sidebar-toggle" onclick="toggleSidebar()"><i class="fas fa-bars icon-collapsed"></i></button>
    <header><nav class="navbar"><div class="logo">Huellas al Corazón</div></nav></header>

    <div id="mySidebar" class="sidebar">
        <a href="{{ url_for('index') }}"><i class="fas fa-home icon"></i> <span class="link-text">Inicio</span></a>
        <a href="{{ url_for('adopt') }}"><i class="fas fa-paw icon"></i> <span class="link-text">Adoptar</span></a>
        <a href="{{ url_for('my_adoptions') }}"><i class="fas fa-heart icon"></i> <span class="link-text">Mis Adopciones</span></a>
        
        <a href="{{ url_for('change_password') }}" style="background-color: rgba(255,255,255,0.2); color: white;">
            <i class="fas fa-key icon"></i> <span class="link-text">Cambiar Clave</span>
        </a>

        {% if current_user.username == 'gfiguera' %}
            <a href="{{ url_for('admin') }}"><i class="fas fa-user-shield icon"></i> <span class="link-text">Admin</span></a>
        {% endif %}
        
        <a href="{{ url_for('logout') }}"><i class="fas fa-sign-out-alt icon"></i> <span class="link-text">Salir</span></a>
    </div>

    <div id="main-content">
        <div class="form-card">
            <h2 style="color: var(--color-azul-electrico);">Definir Nueva Contraseña</h2>
            <p>Ingresa la nueva contraseña que deseas usar a partir de ahora.</p>
            
            <div class="form-group">
                <label>Nueva Contraseña:</label>
                <input type="password" id="new_pass" required>
            </div>

            <div class="form-group">
                <label>Confirmar Nueva Contraseña:</label>
                <input type="password" id="confirm_pass" required>
            </div>
            
            <button class="button primary" onclick="updatePassword()">Guardar Cambios</button>
            <div id="msg-box" style="margin-top:15px; font-weight:bold; display:none;"></div>
        </div>
    </div> 
    
    <div class="dogs-at-bottom-container">
        <img src="{{ url_for('static', filename='pie de pagina.png') }}" class="dogs-at-bottom-image">
    </div>

    <footer><p>&copy; 2023 Huellas al Corazón.</p></footer>

    <script>
        async function updatePassword() {
            // YA NO BUSCAMOS current_pass
            const newPass = document.getElementById('new_pass').value;
            const confirmPass = document.getElementById('confirm_pass').value;
            const msg = document.getElementById('msg-box');

            msg.style.display = 'none';

            if(newPass !== confirmPass) {
                msg.innerText = "Las nuevas contraseñas no coinciden.";
                msg.style.color = "red";
                msg.style.display = 'block';
                return;
            }

            try {
                const res = await fetch('/change_password', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    // SOLO ENVIAMOS LA NUEVA
                    body: JSON.stringify({ new_password: newPass })
                });
                const data = await res.json();

                msg.innerText = data.message;
                msg.style.display = 'block';
                
                if(data.success) {
                    msg.style.color = "green";
                    document.querySelectorAll('input').forEach(i => i.value = '');
                    // Opcional: Redirigir al inicio tras unos segundos
                    setTimeout(() => window.location.href = "{{ url_for('index') }}", 2000);
                } else {
                    msg.style.color = "red";
                }
            } catch(e) {
                msg.innerText = "Error de conexión.";
                msg.style.color = "red";
                msg.style.display = 'block';
            }
        }

        function toggleSidebar() {
            document.getElementById("mySidebar").classList.toggle('open');
            document.getElementById("main-content").classList.toggle('shifted');
        }
    </script>
</body>
</html>